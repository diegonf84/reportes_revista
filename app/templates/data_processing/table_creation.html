{% extends "base.html" %}

{% block title %}Procesamiento de Tablas - Sistema de Reportes{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Procesamiento de Tablas</li>
                </ol>
            </nav>
            <h2><i class="bi bi-table"></i> Procesamiento de Tablas</h2>
            <p class="text-muted">Crear las tablas necesarias para la generación de reportes.</p>
        </div>
    </div>

    <!-- Alert Messages -->
    <div id="alert-container"></div>

    <!-- Process Flow Info -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="bg-light border border-info rounded p-3 mb-3">
                <h6 class="text-info mb-2"><i class="bi bi-info-circle"></i> Orden de Procesamiento Recomendado:</h6>
                <ol class="mb-0">
                    <li><strong>Períodos Recientes:</strong> Crear tabla filtrada con períodos recientes</li>
                    <li><strong>Base Subramos:</strong> Crear tabla agregada por subramos</li>
                    <li><strong>Conceptos Financieros:</strong> Generar tabla con conceptos agregados</li>
                    <li><strong>Subramos Corregida:</strong> Crear tabla con correcciones por trimestre</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Row 1: Preparatory Steps -->
    <div class="row">
        <!-- Create Recent Periods Table -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-calendar-range"></i> Períodos Recientes
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Crea tabla filtrada con datos de períodos recientes para análisis comparativos.</p>
                    
                    <form id="recent-periods-form">
                        {{ recent_periods_form.hidden_tag() }}
                        
                        <div class="mb-3">
                            {{ recent_periods_form.periodo_inicial.label(class="form-label") }}
                            {{ recent_periods_form.periodo_inicial() }}
                            {% if recent_periods_form.periodo_inicial.errors %}
                                <div class="text-danger small">
                                    {% for error in recent_periods_form.periodo_inicial.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Si no se especifica, usa últimos 2 años</div>
                        </div>

                        <div class="d-grid">
                            {{ recent_periods_form.submit() }}
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Create Base Subramos Table -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-table"></i> Base Subramos
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Crea tabla agregada con datos de seguros por subramos utilizando mapeos de cuentas contables.</p>
                    
                    <div class="alert alert-light">
                        <small>
                            <strong>Métricas incluidas:</strong><br>
                            • Primas emitidas y devengadas<br>
                            • Siniestros devengados<br>
                            • Gastos totales<br>
                            • Primas cedidas<br>
                            • Gastos de producción
                        </small>
                    </div>
                    
                    <form id="base-subramos-form">
                        {{ base_subramos_form.hidden_tag() }}
                        
                        <div class="mb-3">
                            {{ base_subramos_form.periodo_inicial.label(class="form-label") }}
                            {{ base_subramos_form.periodo_inicial() }}
                            {% if base_subramos_form.periodo_inicial.errors %}
                                <div class="text-danger small">
                                    {% for error in base_subramos_form.periodo_inicial.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Si no se especifica, usa últimos 2 años</div>
                        </div>

                        <div class="d-grid">
                            {{ base_subramos_form.submit() }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 2: Analysis Steps -->
    <div class="row">
        <!-- Create Financial Concepts Table -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up"></i> Conceptos Financieros
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Genera tabla con conceptos financieros agregados del último período disponible.</p>
                    
                    <div class="alert alert-light">
                        <small>
                            <strong>Conceptos incluidos:</strong><br>
                            • Resultado técnico<br>
                            • Resultado financiero<br>
                            • Patrimonio neto<br>
                            • Inversiones<br>
                            • Y más...
                        </small>
                    </div>
                    
                    <form id="concepts-form">
                        {{ concepts_form.hidden_tag() }}
                        <div class="d-grid">
                            {{ concepts_form.submit() }}
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Create Subramos Table -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-calculator"></i> Subramos Corregida
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Crea tabla de subramos con correcciones específicas según el trimestre.</p>
                    
                    <form id="subramos-form">
                        {{ subramos_form.hidden_tag() }}
                        
                        <div class="mb-3">
                            {{ subramos_form.periodo.label(class="form-label") }}
                            {{ subramos_form.periodo() }}
                            {% if subramos_form.periodo.errors %}
                                <div class="text-danger small">
                                    {% for error in subramos_form.periodo.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                {{ subramos_form.testing_mode() }}
                                {{ subramos_form.testing_mode.label(class="form-check-label") }}
                            </div>
                            <div class="form-text">Genera archivo CSV para verificar cálculos antes de ejecutar</div>
                        </div>

                        <div class="d-grid">
                            {{ subramos_form.submit() }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Status -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-activity"></i> Estado del Procesamiento
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Progress Indicators -->
                    <div id="progress-container" class="d-none mb-3">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border text-info me-2" role="status">
                                <span class="visually-hidden">Procesando...</span>
                            </div>
                            <span id="progress-text">Procesando...</span>
                        </div>
                        <div class="progress mt-2">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                 role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>

                    <!-- Results Display -->
                    <div id="results-container">
                        <div class="text-muted text-center py-4">
                            <i class="bi bi-info-circle"></i>
                            Los resultados del procesamiento aparecerán aquí.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Technical Information -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-secondary">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-gear"></i> Información Técnica
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 col-lg-3">
                            <h6>Tabla Períodos Recientes</h6>
                            <ul class="small">
                                <li>Origen: <code>datos_balance</code></li>
                                <li>Destino: <code>base_balance_ultimos_periodos</code></li>
                                <li>Filtra por fecha especificada</li>
                            </ul>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <h6>Tabla Base Subramos</h6>
                            <ul class="small">
                                <li>Origen: <code>base_balance_ultimos_periodos</code></li>
                                <li>Destino: <code>base_subramos</code></li>
                                <li>Agrega datos por subramos</li>
                            </ul>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <h6>Tabla Conceptos</h6>
                            <ul class="small">
                                <li>Origen: <code>base_balance_ultimos_periodos</code></li>
                                <li>Destino: <code>base_otros_conceptos</code></li>
                                <li>Agrega conceptos financieros</li>
                            </ul>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <h6>Tabla Subramos Corregida</h6>
                            <ul class="small">
                                <li>Origen: <code>base_subramos</code></li>
                                <li>Destino: <code>base_subramos_corregida_actual</code></li>
                                <li>Aplica correcciones por trimestre</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const progressContainer = document.getElementById('progress-container');
    const progressText = document.getElementById('progress-text');
    const resultsContainer = document.getElementById('results-container');
    const alertContainer = document.getElementById('alert-container');

    function showProgress(message) {
        progressText.textContent = message;
        progressContainer.classList.remove('d-none');
    }

    function hideProgress() {
        progressContainer.classList.add('d-none');
    }

    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.appendChild(alertDiv);
        
        setTimeout(() => {
            if (alertDiv && alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    function displayResults(data, operation) {
        let html = `<div class="mb-3">
            <h6><i class="bi bi-check-circle text-success"></i> ${operation} completado exitosamente</h6>
            <p class="text-success mb-0">${escapeHtml(data.message)}</p>
        </div>`;

        if (data.testing_mode) {
            html += `<div class="alert alert-warning">
                <h6><i class="bi bi-file-earmark-text"></i> Modo Testing Activado</h6>
                <p class="mb-0">Se ha generado un archivo CSV para verificación manual.</p>
                <small>Ubicación: <code>modules/testing_data/</code></small>
            </div>`;
        }

        if (data.logs && data.logs.length > 0) {
            html += `<div class="mb-3">
                <h6>Logs de procesamiento:</h6>
                <div class="bg-dark text-light p-3 rounded" style="font-family: 'Courier New', monospace; font-size: 0.9rem; max-height: 400px; overflow-y: auto;">`;
            
            data.logs.forEach(log => {
                if (log.trim()) {
                    let logClass = '';
                    if (log.includes('ERROR')) logClass = 'text-danger';
                    else if (log.includes('WARNING')) logClass = 'text-warning';
                    else if (log.includes('INFO')) logClass = 'text-info';
                    
                    html += `<div class="${logClass}">${escapeHtml(log)}</div>`;
                }
            });
            
            html += `</div></div>`;
        }

        resultsContainer.innerHTML = html;
    }

    function displayError(error, logs = []) {
        let html = `<div class="alert alert-danger">
            <h6><i class="bi bi-exclamation-triangle"></i> Error en el procesamiento</h6>
            <p class="mb-0">${escapeHtml(error)}</p>
        </div>`;

        if (logs && logs.length > 0) {
            html += `<div class="mt-3">
                <h6>Logs de error:</h6>
                <div class="bg-dark text-light p-3 rounded" style="font-family: 'Courier New', monospace; font-size: 0.9rem; max-height: 300px; overflow-y: auto;">`;
            
            logs.forEach(log => {
                if (log.trim()) {
                    html += `<div class="text-danger">${escapeHtml(log)}</div>`;
                }
            });
            
            html += `</div></div>`;
        }

        resultsContainer.innerHTML = html;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function makeRequest(endpoint, data, operation) {
        showProgress(`Ejecutando ${operation}...`);
        
        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            hideProgress();
            if (data.success) {
                displayResults(data, operation);
                showAlert('success', data.message);
            } else {
                displayError(data.error, data.logs);
                showAlert('danger', `Error en ${operation}`);
            }
        })
        .catch(error => {
            hideProgress();
            displayError('Error de conexión: ' + error.message);
            showAlert('danger', 'Error de conexión');
        });
    }

    // Recent Periods Form
    document.getElementById('recent-periods-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const periodo_inicial = formData.get('periodo_inicial');
        
        const requestData = {};
        if (periodo_inicial) {
            requestData.periodo_inicial = parseInt(periodo_inicial);
        }
        
        makeRequest('/data-processing/api/create-recent-periods', requestData, 'Creación de tabla de períodos recientes');
    });

    // Base Subramos Form
    document.getElementById('base-subramos-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const periodo_inicial = formData.get('periodo_inicial');
        
        const requestData = {};
        if (periodo_inicial) {
            requestData.periodo_inicial = parseInt(periodo_inicial);
        }
        
        makeRequest('/data-processing/api/create-base-subramos', requestData, 'Creación de tabla base de subramos');
    });

    // Concepts Form
    document.getElementById('concepts-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        makeRequest('/data-processing/api/create-concepts', {}, 'Creación de tabla de conceptos financieros');
    });

    // Subramos Form
    document.getElementById('subramos-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const periodo = formData.get('periodo');
        const testing_mode = formData.get('testing_mode') === 'y';
        
        if (!periodo) {
            showAlert('warning', 'El período es requerido para la tabla de subramos');
            return;
        }
        
        const requestData = {
            periodo: parseInt(periodo),
            testing_mode: testing_mode
        };
        
        const operation = testing_mode ? 'Generación de archivo de testing' : 'Creación de tabla de subramos corregida';
        makeRequest('/data-processing/api/create-subramos', requestData, operation);
    });
});
</script>
{% endblock %}